package com.ssafy.cafe.controller.rest;

import java.net.URLDecoder;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CookieValue;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.ssafy.cafe.model.dto.Grade;
import com.ssafy.cafe.model.dto.Order;
import com.ssafy.cafe.model.dto.User;
import com.ssafy.cafe.model.service.OrderService;
import com.ssafy.cafe.model.service.UserService;

import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.servlet.http.Cookie;
import jakarta.servlet.http.HttpServletResponse;

@RestController
@RequestMapping("/rest/user")
@CrossOrigin("*")
@Tag(name = "user controller", description = "ì‚¬ìš©ì ë¡œê·¸ì¸ë“± ì‚¬ìš©ì ê¸°ëŠ¥ì„ ì •ì˜í•œë‹¤.")
public class UserRestController {


    
    
    UserService userService;
    OrderService orderService;
    public UserRestController(UserService userService, OrderService orderService){
    	this.userService = userService;
    	this.orderService = orderService;
    }
    
    
    
    
    @PostMapping("")
    public boolean join(@RequestBody User user){
    	int result = userService.join(user);
    	if(result >0) {
    		return true;
    	}
    	else {
    		return false;
    	}
    }
    
    @PostMapping("/login")
    public User login(@RequestBody User user , HttpServletResponse response) {
    	User ruser = userService.login(user.getId(), user.getPass());
    	
    	if(ruser != null) {
    		String encodedId = URLEncoder.encode(user.getId(), StandardCharsets.UTF_8);
    		Cookie cookie = new Cookie("loginId", encodedId);
    		cookie.setMaxAge(60 * 60 * 24 * 30);
    		cookie.setPath("/");
    		response.addCookie(cookie);
    		
    	}else {
    		
    	}
    	return ruser;
    }
    
    @GetMapping("/isUsed")
    public boolean isUsed(@RequestParam String id) {
    	return userService.isUsedId(id);
    }
    
    @PostMapping("info")
    public ResponseEntity<Map<String, Object>> getUserInfo(@RequestBody Map<String, Object> userMap, @CookieValue("loginId") String userId) {
        userId = URLDecoder.decode(userId, StandardCharsets.UTF_8);
        int stamps = (int) userMap.getOrDefault("stamps", 0);

        // ì„œë¹„ìŠ¤ì—ì„œ ì •ë³´ ì¡°íšŒ
        User user = userService.selectUser(userId); // full user info
        List<Order> orders = orderService.getOrderByUser(userId);
        Map<String, Object> grade = this.getGrade(stamps);

        // ì‘ë‹µ Map êµ¬ì„±
        Map<String, Object> result = new HashMap<>();
        result.put("user", user);
        result.put("order", orders);
        result.put("grade", grade);

        return ResponseEntity.ok(result);
    }
    
    
    
    
    /**
     * ì‚¬ìš©ì ë“±ê¸‰ì •ë³´ë¥¼ ê³„ì‚°í•˜ì—¬ ë¦¬í„´í•œë‹¤.
     * ì´ë¯¸ì§€ê°€ seeds.png, ë“±ê¸‰ì´ ì”¨ì•—, stepì´ 10, stepMaxê°€ 1, toê°€ 7 ì´ë¼ë©´,
     * ì”¨ì•— 1ë‹¨ê³„ ë“±ê¸‰ì˜ ì‚¬ìš©ìê°€ ë‹¤ìŒë‹¨ê³„ë¡œ ê°€ë ¤ë©´ 7ê°œ ë” ëª¨ì•„ì•¼ í•¨ì„ ì˜ë¯¸í•œë‹¤.
     *  img, step, stepMax, to, titleì´ ê° keyê°€ ë˜ê³ , 
     *  ê°ê°ì˜ keyì„ ë§ê²Œ ì…ë ¥í•˜ì—¬ ë¦¬í„´í•˜ë©´ ëœë‹¤.
     *   
     *  src/test/javaì— ìˆëŠ” í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ í†µê³¼í•˜ë©´ ì •ìƒë™ì‘í•œë‹¤. 
     *   
     * @param stamp
     * @return
     */
    public Map<String, Object> getGrade(Integer stamp) {
        Map<String, Object> grade = new HashMap<>();
        // ë“±ê¸‰ ê³„ì‚° êµ¬í˜„.

        String[] titles = {"ì”¨ì•—", "ìƒˆì‹¹", "ììƒˆ", "ë‚˜ë¬´"};
        String[] imgs = {"seeds.png", "sprout.png", "leaf.png", "tree.png"};
        int stepMax = 10;

        // ğŸ’¡ 1ë¶€í„° ì‹œì‘í•˜ëŠ” êµ¬ê°„ì„ ìœ„í•œ step ê³„ì‚°
        int step = (stamp - 1) / stepMax;
        if (stamp <= 0) step = 0; // ì˜ˆì™¸ ì²˜ë¦¬

        // ìµœëŒ€ ë‹¨ê³„ ì´ˆê³¼ ì‹œ ì œí•œ
        if (step >= titles.length) {
            step = titles.length - 1;
        }

        // ë‹¤ìŒ ë‹¨ê³„ê¹Œì§€ í•„ìš”í•œ ìŠ¤íƒ¬í”„ ìˆ˜
        int toNext = 0;
        if (step < titles.length - 1) {
            int currentMax = (step + 1) * stepMax;
            toNext = currentMax - stamp;
        }

        grade.put("img", imgs[step]);
        grade.put("step", step);
        grade.put("stepMax", stepMax);
        grade.put("to", toNext);
        grade.put("title", titles[step]);

        
        return grade;
        
        
    }

    

}
